name: Draft Release

on:
  workflow_run:
    workflows:
      - CI Build
    types:
      - completed

permissions:
  contents: write
  actions: read

jobs:
  create-draft-release:
    name: Create draft release from CI artifacts
    permissions:
      contents: write
      actions: read
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Check out built revision
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 1

      - name: Resolve release tag and check if it exists
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          current_version="$(sed -nE 's/^version = "([^"]+)"/\1/p' Cargo.toml | head -n1)"

          if [[ -z "${current_version}" ]]; then
            echo "Could not determine current Cargo.toml version" >&2
            exit 1
          fi

          tag="v${current_version}"
          release_exists=false
          if gh release view "$tag" >/dev/null 2>&1; then
            release_exists=true
          fi

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "release_exists=${release_exists}" >> "$GITHUB_OUTPUT"

      - name: Download binary artifacts from CI Build run
        if: steps.version.outputs.release_exists != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p dist
          mapfile -t artifact_ids < <(
            gh api "repos/${REPO}/actions/runs/${RUN_ID}/artifacts" \
              --jq '.artifacts[] | select(.name | startswith("release-")) | .id'
          )

          if [[ ${#artifact_ids[@]} -eq 0 ]]; then
            echo "No release-* artifacts found on run ${RUN_ID}" >&2
            exit 1
          fi

          for id in "${artifact_ids[@]}"; do
            zip_path="artifact-${id}.zip"
            gh api "repos/${REPO}/actions/artifacts/${id}/zip" > "${zip_path}"
            unzip -o "${zip_path}" -d dist
            rm -f "${zip_path}"
          done

      - name: Ensure Unix binaries are executable
        if: steps.version.outputs.release_exists != 'true'
        shell: bash
        run: |
          set -euo pipefail

          shopt -s nullglob
          for path in dist/*; do
            if [[ -f "$path" && "$path" != *.exe ]]; then
              chmod 755 "$path"
            fi
          done

      - name: Create draft release and attach binaries
        if: steps.version.outputs.release_exists != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          tag="${{ steps.version.outputs.tag }}"
          title="$tag"

          gh release create "$tag" \
            --target "${{ github.event.workflow_run.head_sha }}" \
            --draft \
            --title "$title" \
            --generate-notes

          gh release upload "$tag" dist/* --clobber
