name: Draft Release

on:
  workflow_run:
    workflows:
      - CI Build
    types:
      - completed

permissions:
  contents: write
  actions: read

jobs:
  create-draft-release:
    name: Create draft release from CI artifacts
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    steps:
      - name: Check out built revision
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 2

      - name: Detect Cargo version bump
        id: version
        shell: bash
        run: |
          set -euo pipefail

          current_version="$(sed -nE 's/^version = "([^"]+)"/\1/p' Cargo.toml | head -n1)"
          previous_version="$(git show HEAD^:Cargo.toml 2>/dev/null | sed -nE 's/^version = "([^"]+)"/\1/p' | head -n1 || true)"

          if [[ -z "${current_version}" ]]; then
            echo "Could not determine current Cargo.toml version" >&2
            exit 1
          fi

          bumped=false
          if [[ -n "${previous_version}" && "${current_version}" != "${previous_version}" ]]; then
            bumped=true
          fi

          echo "bumped=${bumped}" >> "$GITHUB_OUTPUT"
          echo "tag=v${current_version}" >> "$GITHUB_OUTPUT"

      - name: Download binary artifacts from CI Build run
        if: steps.version.outputs.bumped == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p dist
          mapfile -t artifact_ids < <(
            gh api "repos/${REPO}/actions/runs/${RUN_ID}/artifacts" \
              --jq '.artifacts[] | select(.name | startswith("release-")) | .id'
          )

          if [[ ${#artifact_ids[@]} -eq 0 ]]; then
            echo "No release-* artifacts found on run ${RUN_ID}" >&2
            exit 1
          fi

          for id in "${artifact_ids[@]}"; do
            zip_path="artifact-${id}.zip"
            gh api "repos/${REPO}/actions/artifacts/${id}/zip" > "${zip_path}"
            unzip -o "${zip_path}" -d dist
            rm -f "${zip_path}"
          done

      - name: Create draft release and attach binaries
        if: steps.version.outputs.bumped == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          tag="${{ steps.version.outputs.tag }}"
          title="$tag"

          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Draft release for $tag already exists"
          else
            gh release create "$tag" \
              --target "${{ github.event.workflow_run.head_sha }}" \
              --draft \
              --title "$title" \
              --generate-notes
          fi

          gh release upload "$tag" dist/* --clobber
